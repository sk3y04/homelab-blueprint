# ==========================================================================
# Promtail Configuration — Docker Log Shipper
# ==========================================================================
# Discovers all running Docker containers via the Docker socket and
# ships their logs to Loki. Each container's logs are automatically
# labelled with the container name for easy filtering in Grafana.
#
# Also collects host syslog (/var/log/syslog, /var/log/auth.log).
# ==========================================================================

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # ── Docker container logs (auto-discovery) ──────────────────────────────
  # Uses the Docker socket to find all running containers and tail their
  # log files from /var/lib/docker/containers.
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
    relabel_configs:
      # Extract clean container name (strip leading /).
      - source_labels: ["__meta_docker_container_name"]
        regex: "/(.*)"
        target_label: "container"

      # Use the compose project as a "stack" label.
      - source_labels: ["__meta_docker_container_label_com_docker_compose_project"]
        target_label: "compose_project"

      # Use the compose service name.
      - source_labels: ["__meta_docker_container_label_com_docker_compose_service"]
        target_label: "compose_service"

  # ── Host system logs ────────────────────────────────────────────────────
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          __path__: /var/log/{syslog,auth.log,kern.log}
