# --------------------------------------------------------------------------------
# Nextcloud Personal Cloud Stack
# --------------------------------------------------------------------------------
# This Docker Compose configuration sets up a complete Nextcloud instance with
# a database and caching layer for performance and reliability.
#
# Services:
#   - db:    MariaDB database for storing Nextcloud metadata.
#   - redis: Redis in-memory data structure store for caching and file locking.
#   - app:   The Nextcloud web application (Apache variant).
#   - cron:  (If present) Background job processor for Nextcloud maintenance.
#
# Networking:
#   - All services communicate on a private 'nextcloud' network.
#   - Only the 'app' service exposes a port (HTTP) for external access.
# --------------------------------------------------------------------------------

services:
  # MariaDB database backing the Nextcloud instance.
  db:
    image: mariadb:10.11
    container_name: nextcloud_db
    # Automatically restart the container unless explicitly stopped.
    restart: unless-stopped

    # Use sane transaction isolation and binary logging for Nextcloud.
    command: --transaction-isolation=READ-COMMITTED --log-bin=binlog --binlog-format=ROW

    # Persist database files on the host.
    volumes:
      - ${NEXTCLOUD_DB_DIR}:/var/lib/mysql

    # Database credentials and settings sourced from .env.
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MARIADB_AUTO_UPGRADE=${MARIADB_AUTO_UPGRADE}
      - TZ=${DB_TZ}

    networks:
      - nextcloud

  # Redis cache for transactional file locking and performance.
  redis:
    image: redis:7-alpine
    container_name: nextcloud_redis
    # Automatically restart the container unless explicitly stopped.
    restart: unless-stopped

    # Protect Redis with a password.
    command: redis-server --requirepass ${REDIS_PASSWORD}

    # Persist Redis data on the host.
    volumes:
      - ${NEXTCLOUD_REDIS_DIR}:/data

    networks:
      - nextcloud

  # Main Nextcloud web application (Apache-based image).
  app:
    image: nextcloud:32-apache
    container_name: nextcloud_app
    # Automatically restart the container unless explicitly stopped.
    restart: unless-stopped

    # Expose HTTP port on the host; typically reverse-proxied by nginx.
    ports:
      - "${NEXTCLOUD_HTTP_PORT}:80"

    # Ensure database and Redis are available before starting.
    depends_on:
      - db
      - redis

    # Persist core Nextcloud data, config, and apps; mount external storage.
    volumes:
      - nextcloud:/var/www/html
      - ${NEXTCLOUD_DATA_DIR}:/var/www/html/data
      - ${NEXTCLOUD_CONFIG_DIR}:/var/www/html/config
      - ${NEXTCLOUD_CUSTOM_APPS_DIR}:/var/www/html/custom_apps
      - ${NEXTCLOUD_THEMES_DIR}:/var/www/html/themes
      - ${RAID_ROOT_DIR}:/mnt/external/raid6

    # Application-level configuration (DB/Redis connection, limits, domains).
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_HOST=db
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD=${REDIS_PASSWORD}
      - NEXTCLOUD_TRUSTED_DOMAINS=${NEXTCLOUD_TRUSTED_DOMAINS}
      - PHP_MEMORY_LIMIT=${NEXTCLOUD_PHP_MEMORY_LIMIT}
      - PHP_UPLOAD_LIMIT=${NEXTCLOUD_PHP_UPLOAD_LIMIT}
      - TZ=${NEXTCLOUD_TZ}

    networks:
      - nextcloud

  # Separate container running Nextcloud's cron jobs.
  cron:
    image: nextcloud:32-apache
    container_name: nextcloud_cron
    restart: unless-stopped

    # Use the cron entrypoint provided by the Nextcloud image.
    entrypoint: /cron.sh

    depends_on:
      - db
      - redis

    # Mount the same volumes as the main app container.
    volumes:
      - nextcloud:/var/www/html
      - ${NEXTCLOUD_DATA_DIR}:/var/www/html/data
      - ${NEXTCLOUD_CONFIG_DIR}:/var/www/html/config
      - ${NEXTCLOUD_CUSTOM_APPS_DIR}:/var/www/html/custom_apps
      - ${NEXTCLOUD_THEMES_DIR}:/var/www/html/themes
      - ${RAID_ROOT_DIR}:/mnt/external/raid6

    # Use the same DB/Redis config and PHP limits as the app container.
    environment:
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_HOST=db
      - REDIS_HOST=redis
      - REDIS_HOST_PASSWORD=${REDIS_PASSWORD}
      - PHP_MEMORY_LIMIT=${NEXTCLOUD_PHP_MEMORY_LIMIT}
      - PHP_UPLOAD_LIMIT=${NEXTCLOUD_PHP_UPLOAD_LIMIT}
      - TZ=${NEXTCLOUD_TZ}

    networks:
      - nextcloud

networks:
  # Isolated bridge network for Nextcloud stack components.
  nextcloud:
    driver: bridge
    
volumes:
  # Named volume for Nextcloud core files.
  nextcloud:
