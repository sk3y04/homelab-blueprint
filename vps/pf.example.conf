# /etc/pf.conf
# ==========================================================================
# PF Firewall Configuration â€” FreeBSD VPS
# ==========================================================================
# This is an example template. Replace 10.8.0.2 with your actual OpenVPN
# tunnel IP. Adjust ports to match your deployed services.
# ==========================================================================

ext_if="vtnet0"
ovpn_if="tun1"
home_ip="10.8.0.2"

web_ports = "{80 443}"
ssh_port  = "22"
ovpn_port = "1194"
# Ports correspond to services in NETWORK.md (Jellyfin, Nextcloud, Code, Guacamole, qBittorrent, Soulseek, Authelia, CoolerControl, Minecraft, Grafana)
home_service_ports = "{8096 80 8443 8080 8081 6080 9091 11987 25565 3100}"

# 1. Add the fail2ban table definition here
table <fail2ban> persist
table <blocked> persist

set block-policy drop
set skip on lo
scrub in all fragment reassemble

# 2. Add the block rule early in the ruleset
block drop in quick from <fail2ban>
block in quick from <blocked>
block in all
block out all

# Allow all outbound (creates states so replies are allowed)
pass out quick keep state

# Public inbound services
pass in on $ext_if proto tcp to ($ext_if) port $web_ports keep state
pass in on $ext_if proto tcp to ($ext_if) port $ssh_port  keep state
pass in on $ext_if proto udp to ($ext_if) port $ovpn_port keep state
pass in on $ext_if inet proto icmp to ($ext_if) keep state

# Outbound to home services over VPN tunnel
pass out on $ovpn_if proto tcp to $home_ip port $home_service_ports keep state
